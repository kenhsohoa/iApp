<script>
  // ===================================================================
  // iAPP PRO V5.0 - CORE APPLICATION
  // Modular, Safe, Error-handled
  // ===================================================================

  // ===================================================================
  // 1. APPLICATION STATE
  // ===================================================================
  const App = {
    // State
    state: {
      sessionId: null,
      user: null,
      apps: [],
      categories: [],
      users: [],
      favorites: [],
      ratings: {},
      permissions: {},
      stats: {}
    },

    // UI State
    ui: {
      currentTab: 'home',
      isDesktop: false,
      sidebarOpen: false,
      sidebarExpanded: true,
      panelOpen: false,
      selectedApp: null,
      editingApp: null,
      editingUser: null,
      editingCat: null,
      theme: 'dark'
    },

    // Settings
    settings: {
      theme: 'dark',
      hideTabBarOnScroll: true,  // ‚≠ê TH√äM M·ªöI
      viewMode: 'grid',          // ‚≠ê TH√äM M·ªöI
      itemsPerPage: 20           // ‚≠ê TH√äM M·ªöI
    },

    // Recent data
    recent: {
      apps: [],
      searches: []
    },

    // Storage keys
    KEYS: {
      SESSION: 'iapp_v5_session',
      SETTINGS: 'iapp_v5_settings',
      RECENT: 'iapp_v5_recent',
      FAVORITES_LOCAL: 'iapp_v5_favs'
    },

    // ===================================================================
    // 2. INITIALIZATION
    // ===================================================================
    init() {
      console.log('üöÄ iApp Pro V5.0 initializing...');

      try {
        // Load settings
        this.loadSettings();
        this.applyTheme();

        // Load recent data
        this.recent.apps = this.storage.get(this.KEYS.RECENT, []);

        // Check for existing session
        const savedSession = localStorage.getItem(this.KEYS.SESSION) ||
          sessionStorage.getItem(this.KEYS.SESSION);

        if (savedSession) {
          this.state.sessionId = savedSession;
          this.validateSession();
        } else {
          this.showLogin();
        }

        // Setup responsive
        this.setupResponsive();

        // Setup keyboard shortcuts
        this.setupKeyboard();

        // ‚≠ê Delay kh·ªüi t·∫°o History & ScrollBehavior sau khi DOM ready
        // (ƒë·ªÉ ƒë·∫£m b·∫£o UI ƒë√£ ƒë∆∞·ª£c load)
        setTimeout(() => {
          if (typeof History !== 'undefined') History.init();
          if (typeof ScrollBehavior !== 'undefined') ScrollBehavior.init();
        }, 100);

      } catch (error) {
        console.error('Init error:', error);
        this.showError('L·ªói kh·ªüi t·∫°o: ' + error.message);
      }
    },

    // ===================================================================
    // 3. STORAGE UTILITIES
    // ===================================================================
    storage: {
      get(key, defaultVal = null) {
        try {
          const val = localStorage.getItem(key);
          return val ? JSON.parse(val) : defaultVal;
        } catch {
          return defaultVal;
        }
      },

      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.warn('Storage error:', e);
        }
      },

      remove(key) {
        try {
          localStorage.removeItem(key);
        } catch (e) {
          console.warn('Storage remove error:', e);
        }
      }
    },

    // ===================================================================
    // 4. SETTINGS
    // ===================================================================
    loadSettings() {
      const saved = this.storage.get(this.KEYS.SETTINGS, {});
      this.settings = { ...this.settings, ...saved };
      this.ui.theme = this.settings.theme;
      this.ui.sidebarExpanded = this.storage.get('iapp_sidebar', true);
    },

    saveSettings() {
      this.storage.set(this.KEYS.SETTINGS, this.settings);
    },

    applyTheme() {
      document.body.classList.toggle('light-theme', this.settings.theme === 'light');

      const themeColor = this.settings.theme === 'light' ? '#f8fafc' : '#0f172a';
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) metaTheme.content = themeColor;

      // Update icon
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon) {
        themeIcon.className = this.settings.theme === 'light' ? 'fas fa-sun' : 'fas fa-moon';
      }
    },

    toggleTheme() {
      this.settings.theme = this.settings.theme === 'light' ? 'dark' : 'light';
      this.saveSettings();
      this.applyTheme();
      Toast.show('ƒê√£ ƒë·ªïi giao di·ªán', 'success');
    },

    // ===================================================================
    // 5. RESPONSIVE SETUP
    // ===================================================================
    setupResponsive() {
      const checkDesktop = () => {
        const wasDesktop = this.ui.isDesktop;
        this.ui.isDesktop = window.innerWidth >= 1024;

        if (wasDesktop !== this.ui.isDesktop) {
          this.onLayoutChange();
        }
      };

      checkDesktop();

      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(checkDesktop, 150);
      });
    },

    onLayoutChange() {
      if (this.ui.isDesktop) {
        // Show sidebar
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.classList.toggle('expanded', this.ui.sidebarExpanded);
        }
      }

      // ‚≠ê TH√äM KI·ªÇM TRA: Ch·ªâ render khi UI ƒë√£ s·∫µn s√†ng
      if (this.state.apps.length > 0 && typeof UI !== 'undefined') {
        UI.render();
      }
    },

    // ===================================================================
    // 6. KEYBOARD SHORTCUTS
    // ===================================================================
    setupKeyboard() {
      document.addEventListener('keydown', (e) => {
        // Escape - close modals
        if (e.key === 'Escape') {
          Modal.closeAll();
        }

        // Ctrl+K - focus search
        if (e.ctrlKey && e.key === 'k') {
          e.preventDefault();
          const search = document.getElementById('global-search');
          if (search) search.focus();
        }

        // Ctrl+B - toggle sidebar (desktop)
        if (e.ctrlKey && e.key === 'b' && this.ui.isDesktop) {
          e.preventDefault();
          this.toggleSidebar();
        }
      });
    },

    // ===================================================================
    // 7. AUTHENTICATION
    // ===================================================================
    showLogin() {
      document.getElementById('initial-loader')?.classList.add('hidden');
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    },

    showMain() {
      document.getElementById('initial-loader')?.classList.add('hidden');
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'flex';
    },

    showError(message) {
      document.getElementById('initial-loader')?.classList.add('hidden');
      document.getElementById('error-detail').textContent = message;
      document.getElementById('error-fallback').classList.add('show');
    },

    handleLogin(event) {
      event.preventDefault();

      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      if (!username || !password) {
        Toast.show('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
        return false;
      }

      const btn = document.getElementById('btn-login');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');

      btn.disabled = true;
      btnText.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
      btnLoading.style.display = 'inline-block';

      API.call('login', [username, password])
        .then(result => {
          if (result.success) {
            this.state.sessionId = result.sessionId;
            this.state.user = result.user;
            localStorage.setItem(this.KEYS.SESSION, result.sessionId);
            Toast.show('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
            this.loadData();
          } else {
            Toast.show(result.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i', 'error');
          }
        })
        .catch(error => {
          Toast.show('L·ªói: ' + error.message, 'error');
        })
        .finally(() => {
          btn.disabled = false;
          btnText.textContent = 'ƒêƒÉng nh·∫≠p';
          btnLoading.style.display = 'none';
        });

      return false;
    },

    loginAsGuest() {
      Loading.show('ƒêang v√†o...');

      API.call('loginAsGuest')
        .then(result => {
          if (result.success) {
            this.state.sessionId = result.sessionId;
            this.state.user = result.user;
            sessionStorage.setItem(this.KEYS.SESSION, result.sessionId);
            Toast.show('Ch√†o m·ª´ng!', 'success');
            this.loadData();
          } else {
            Loading.hide();
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    validateSession() {
      Loading.show('ƒêang x√°c th·ª±c...');

      API.call('validateSession', [this.state.sessionId])
        .then(result => {
          if (result.valid) {
            this.state.user = result.user;
            this.loadData();
          } else {
            this.clearSession();
            Loading.hide();
            this.showLogin();
            if (result.error) Toast.show(result.error, 'warning');
          }
        })
        .catch(error => {
          this.clearSession();
          Loading.hide();
          this.showLogin();
          Toast.show('L·ªói k·∫øt n·ªëi', 'error');
        });
    },

    logout() {
      Modal.confirm('ƒêƒÉng xu·∫•t', 'B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?', () => {
        Loading.show('ƒêang ƒëƒÉng xu·∫•t...');

        API.call('logout', [this.state.sessionId])
          .then(() => {
            this.clearSession();
            Loading.hide();
            this.showLogin();
            Toast.show('ƒê√£ ƒëƒÉng xu·∫•t', 'info');

            // Reset form
            const form = document.getElementById('login-form');
            if (form) form.reset();
          })
          .catch(() => {
            this.clearSession();
            Loading.hide();
            this.showLogin();
          });
      });
    },

    clearSession() {
      localStorage.removeItem(this.KEYS.SESSION);
      sessionStorage.removeItem(this.KEYS.SESSION);
      this.state.sessionId = null;
      this.state.user = null;
      this.state.apps = [];
      this.state.categories = [];
      this.state.users = [];
      this.state.favorites = [];
    },

    togglePassword() {
      const input = document.getElementById('login-password');
      const icon = document.getElementById('password-icon');

      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    },

    // ===================================================================
    // 8. DATA LOADING
    // ===================================================================
    loadData() {
      Loading.show('ƒêang t·∫£i d·ªØ li·ªáu...');

      API.call('getInitialData', [this.state.sessionId])
        .then(result => {
          Loading.hide();

          if (result.success) {
            // Update state
            this.state.user = result.user;
            this.state.apps = result.apps || [];
            this.state.categories = result.categories || [];
            this.state.users = result.users || [];
            this.state.favorites = result.favorites || [];
            this.state.ratings = result.ratings || {};
            this.state.permissions = result.permissions || {};
            this.state.stats = result.stats || {};

            // Show main app
            this.showMain();

            // Render UI
            UI.init();
            UI.render();

          } else if (result.requiresAuth) {
            this.clearSession();
            this.showLogin();
            Toast.show(result.error || 'Phi√™n h·∫øt h·∫°n', 'warning');
          } else {
            Toast.show(result.error || 'L·ªói t·∫£i d·ªØ li·ªáu', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
          this.showLogin();
        });
    },

    refreshData() {
      Toast.show('ƒêang l√†m m·ªõi...', 'info');
      this.loadData();
    },

    // ===================================================================
    // 9. NAVIGATION
    // ===================================================================
    switchTab(tabName) {
      // Push history tr∆∞·ªõc khi chuy·ªÉn tab
      if (!History.isNavigating) {
        History.push({ type: 'tab', tab: tabName });
      }

      this.ui.currentTab = tabName;

      // Update tab bar
      document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabName);
      });

      // Update sidebar nav
      document.querySelectorAll('.sidebar-nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabName);
      });

      // Render content
      UI.renderPage(tabName);

      // Scroll to top
      const pageContent = document.getElementById('page-content');
      if (pageContent) pageContent.scrollTop = 0;

      // Close mobile sidebar
      if (!this.ui.isDesktop) {
        this.closeSidebar();
      }
    },

    toggleSidebar() {
      if (this.ui.isDesktop) {
        this.ui.sidebarExpanded = !this.ui.sidebarExpanded;
        document.getElementById('sidebar')?.classList.toggle('expanded', this.ui.sidebarExpanded);
        this.storage.set('iapp_sidebar', this.ui.sidebarExpanded);
      } else {
        this.ui.sidebarOpen = !this.ui.sidebarOpen;
        document.getElementById('sidebar')?.classList.toggle('open', this.ui.sidebarOpen);

        if (this.ui.sidebarOpen) {
          Modal.showOverlay('sidebar-overlay', () => this.closeSidebar());
        } else {
          Modal.hideOverlay('sidebar-overlay');
        }
      }
    },

    closeSidebar() {
      this.ui.sidebarOpen = false;
      document.getElementById('sidebar')?.classList.remove('open');
      Modal.hideOverlay('sidebar-overlay');
    },

    // ===================================================================
    // 10. PANEL (Desktop detail view)
    // ===================================================================
    openPanel(appId) {
      const app = this.state.apps.find(a => a.id === appId);
      if (!app) {
        Toast.show('Kh√¥ng t√¨m th·∫•y ·ª©ng d·ª•ng', 'error');
        return;
      }

      this.ui.selectedApp = app;
      this.ui.panelOpen = true;
      this.addRecent(appId);

      // Increment views
      API.call('incrementViews', [this.state.sessionId, appId]);
      app.views = (app.views || 0) + 1;

      // Push history
      History.push({ type: 'app-detail', appId: appId });

      // Render panel
      UI.renderPanel(app);

      document.getElementById('side-panel')?.classList.add('open');
    },


    closePanel() {
      this.ui.panelOpen = false;
      this.ui.selectedApp = null;
      document.getElementById('side-panel')?.classList.remove('open');
    },

    // ===================================================================
    // 11. APP DETAIL (Mobile)
    // ===================================================================
    openAppDetail(appId) {
      if (this.ui.isDesktop) {
        this.openPanel(appId);
        return;
      }

      const app = this.state.apps.find(a => a.id === appId);
      if (!app) {
        Toast.show('Kh√¥ng t√¨m th·∫•y ·ª©ng d·ª•ng', 'error');
        return;
      }

      this.ui.selectedApp = app;
      this.addRecent(appId);

      // Increment views
      API.call('incrementViews', [this.state.sessionId, appId]);
      app.views = (app.views || 0) + 1;

      // Push history
      History.push({ type: 'app-detail', appId: appId });

      // Show detail sheet
      Modal.showSheet('app-detail', UI.renderAppDetailContent(app));
    },


    // ===================================================================
    // 12. RECENT APPS
    // ===================================================================
    addRecent(appId) {
      this.recent.apps = this.recent.apps.filter(id => id !== appId);
      this.recent.apps.unshift(appId);
      if (this.recent.apps.length > 10) {
        this.recent.apps = this.recent.apps.slice(0, 10);
      }
      this.storage.set(this.KEYS.RECENT, this.recent.apps);
    },

    // ===================================================================
    // 13. SEARCH
    // ===================================================================
    handleSearch(query) {
      query = query.trim();

      if (!query) {
        UI.renderPage(this.ui.currentTab);
        return;
      }

      const results = this.searchApps(query);
      UI.renderSearchResults(results, query);
    },

    searchApps(query) {
      query = query.toLowerCase();
      return this.state.apps.filter(app => {
        const name = (app.name || '').toLowerCase();
        const desc = (app.description || '').toLowerCase();
        const cat = (app.category || '').toLowerCase();
        const tags = (app.tags || '').toLowerCase();
        return name.includes(query) || desc.includes(query) ||
          cat.includes(query) || tags.includes(query);
      });
    },

    // ===================================================================
    // 14. FAVORITES
    // ===================================================================
    isGuest() {
      return this.state.user && (this.state.user.id === 'GUEST' || this.state.user.role === 'Guest');
    },

    getLocalFavorites() {
      return this.storage.get(this.KEYS.FAVORITES_LOCAL, []);
    },

    isFavorite(appId) {
      if (this.isGuest()) {
        return this.getLocalFavorites().includes(appId);
      }
      return this.state.favorites.includes(appId);
    },

    toggleFavorite(appId, btnElement) {
      if (this.isGuest()) {
        // Local favorites for guests
        let favs = this.getLocalFavorites();
        const index = favs.indexOf(appId);

        if (index === -1) {
          favs.push(appId);
          Toast.show('ƒê√£ th√™m y√™u th√≠ch', 'success');
        } else {
          favs.splice(index, 1);
          Toast.show('ƒê√£ b·ªè y√™u th√≠ch', 'info');
        }

        this.storage.set(this.KEYS.FAVORITES_LOCAL, favs);
        this.updateFavUI(appId, index === -1, btnElement);
        this.updateFavBadge();
        return;
      }

      // Server-side favorites
      const wasFav = this.isFavorite(appId);

      // Optimistic update
      if (wasFav) {
        this.state.favorites = this.state.favorites.filter(id => id !== appId);
      } else {
        this.state.favorites.push(appId);
      }
      this.updateFavUI(appId, !wasFav, btnElement);
      this.updateFavBadge();

      API.call('toggleFavorite', [this.state.sessionId, appId])
        .then(result => {
          if (result.success) {
            Toast.show(result.message, 'success');
          } else {
            // Rollback
            if (wasFav) {
              this.state.favorites.push(appId);
            } else {
              this.state.favorites = this.state.favorites.filter(id => id !== appId);
            }
            this.updateFavUI(appId, wasFav, btnElement);
            this.updateFavBadge();
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          // Rollback
          if (wasFav) {
            this.state.favorites.push(appId);
          } else {
            this.state.favorites = this.state.favorites.filter(id => id !== appId);
          }
          this.updateFavUI(appId, wasFav, btnElement);
          this.updateFavBadge();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    updateFavUI(appId, isFav, btn) {
      if (btn) {
        btn.classList.toggle('active', isFav);
        const icon = btn.querySelector('i');
        if (icon) {
          icon.className = isFav ? 'fas fa-heart' : 'far fa-heart';
        }
      }

      // Update all fav buttons for this app
      document.querySelectorAll(`[data-fav-id="${appId}"]`).forEach(el => {
        el.classList.toggle('active', isFav);
        const icon = el.querySelector('i');
        if (icon) {
          icon.className = isFav ? 'fas fa-heart' : 'far fa-heart';
        }
      });
    },

    updateFavBadge() {
      const count = this.isGuest() ? this.getLocalFavorites().length : this.state.favorites.length;

      const badge = document.getElementById('fav-badge');
      if (badge) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = count > 0 ? 'flex' : 'none';
      }
    },

    // ===================================================================
    // 15. RATINGS
    // ===================================================================
    rateApp(appId, stars) {
      if (this.isGuest()) {
        Toast.show('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°', 'warning');
        return;
      }

      // Optimistic update
      if (!this.state.ratings[appId]) {
        this.state.ratings[appId] = { average: 0, count: 0, userRating: 0 };
      }
      const oldRating = this.state.ratings[appId].userRating;
      this.state.ratings[appId].userRating = stars;

      API.call('rateApp', [this.state.sessionId, appId, stars])
        .then(result => {
          if (result.success) {
            this.state.ratings[appId] = {
              average: result.average,
              count: result.count,
              userRating: result.stars
            };

            // Update app in list
            const app = this.state.apps.find(a => a.id === appId);
            if (app) {
              app.avgRating = result.average;
              app.ratingCount = result.count;
            }

            Toast.show(result.message, 'success');
          } else {
            this.state.ratings[appId].userRating = oldRating;
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          this.state.ratings[appId].userRating = oldRating;
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    // ===================================================================
    // 16. APP CRUD
    // ===================================================================
    openAddApp() {
      this.ui.editingApp = null;
      Modal.showSheet('app-form', UI.renderAppForm());
    },

    openEditApp(appId) {
      const app = this.state.apps.find(a => a.id === appId);
      if (!app) {
        Toast.show('Kh√¥ng t√¨m th·∫•y ·ª©ng d·ª•ng', 'error');
        return;
      }

      this.ui.editingApp = app;
      Modal.showSheet('app-form', UI.renderAppForm(app));
    },

    saveApp() {
      const form = document.getElementById('app-form-content');
      if (!form) return;

      const data = {
        id: this.ui.editingApp?.id || null,
        name: document.getElementById('app-name')?.value?.trim(),
        link: document.getElementById('app-link')?.value?.trim(),
        description: document.getElementById('app-desc')?.value?.trim(),
        category: document.getElementById('app-category')?.value,
        visibility: document.getElementById('app-visibility')?.value,
        imageURL: document.getElementById('app-image-url')?.value?.trim(),
        videoURL: document.getElementById('app-video')?.value?.trim(),
        tags: document.getElementById('app-tags')?.value?.trim()
      };

      if (!data.name) {
        Toast.show('Vui l√≤ng nh·∫≠p t√™n ·ª©ng d·ª•ng', 'error');
        return;
      }

      const isNew = !data.id;
      Loading.show(isNew ? 'ƒêang th√™m...' : 'ƒêang l∆∞u...');

      API.call('saveApp', [this.state.sessionId, data, isNew])
        .then(result => {
          Loading.hide();
          if (result.success) {
            Toast.show(result.message || 'ƒê√£ l∆∞u', 'success');
            Modal.close('app-form');
            this.loadData();
          } else {
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    deleteApp(appId) {
      const app = this.state.apps.find(a => a.id === appId);
      if (!app) return;

      Modal.confirm('X√≥a ·ª©ng d·ª•ng', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${app.name}"?`, () => {
        Loading.show('ƒêang x√≥a...');

        API.call('deleteApp', [this.state.sessionId, appId])
          .then(result => {
            Loading.hide();
            if (result.success) {
              Toast.show('ƒê√£ x√≥a', 'success');
              Modal.closeAll();
              this.closePanel();
              this.loadData();
            } else {
              Toast.show(result.error || 'L·ªói', 'error');
            }
          })
          .catch(error => {
            Loading.hide();
            Toast.show('L·ªói: ' + error.message, 'error');
          });
      }, true);
    },

    openAppLink(appId) {
      const app = this.state.apps.find(a => a.id === appId);
      if (app?.link) {
        window.open(app.link, '_blank');
      } else {
        Toast.show('Ch∆∞a c√≥ ƒë∆∞·ªùng d·∫´n', 'warning');
      }
    },

    // ===================================================================
    // 17. CATEGORY HELPERS
    // ===================================================================
    showCategoryApps(catId) {
      const cat = this.state.categories.find(c => c.id === catId);
      if (!cat) return;

      const apps = this.state.apps.filter(a => a.category === cat.name);

      if (this.ui.isDesktop) {
        UI.renderCategoryPage(cat, apps);
      } else {
        Modal.showSheet('category-apps', UI.renderCategorySheet(cat, apps));
      }
    },

    // ===================================================================
    // 18. USER MENU
    // ===================================================================
    toggleUserMenu() {
      const user = this.state.user;
      if (!user) return;

      Modal.showActionSheet([
        { text: `üëã Xin ch√†o, ${user.displayName || user.username}`, disabled: true },
        { text: 'üë§ H·ªì s∆° c√° nh√¢n', handler: () => this.switchTab('profile') },
        { text: 'üé® Giao di·ªán', handler: () => this.openAppearanceSettings() },
        { text: 'üö™ ƒêƒÉng xu·∫•t', destructive: true, handler: () => this.logout() }
      ]);
    },

    openAppearanceSettings() {
      Modal.showSheet('appearance', UI.renderAppearanceSettings());
    },

    // ===================================================================
    // 19. ADMIN FUNCTIONS
    // ===================================================================
    openAdminUsers() {
      Modal.showSheet('admin-users', UI.renderAdminUsers());
    },

    openAdminCategories() {
      Modal.showSheet('admin-categories', UI.renderAdminCategories());
    },

    openAdminStats() {
      Modal.showSheet('admin-stats', UI.renderAdminStats());
    },

    openAdminLogs() {
      Loading.show('ƒêang t·∫£i...');

      API.call('getLogs', [this.state.sessionId, 100])
        .then(result => {
          Loading.hide();
          if (result.success) {
            Modal.showSheet('admin-logs', UI.renderAdminLogs(result.logs));
          } else {
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    // User CRUD
    openAddUser() {
      this.ui.editingUser = null;
      Modal.showSheet('user-form', UI.renderUserForm());
    },

    openEditUser(userId) {
      const user = this.state.users.find(u => u.id === userId);
      if (!user) {
        Toast.show('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng', 'error');
        return;
      }

      this.ui.editingUser = user;
      Modal.showSheet('user-form', UI.renderUserForm(user));
    },

    saveUser() {
      const data = {
        id: this.ui.editingUser?.id || null,
        username: document.getElementById('user-username')?.value?.trim(),
        password: document.getElementById('user-password')?.value,
        displayName: document.getElementById('user-display')?.value?.trim(),
        email: document.getElementById('user-email')?.value?.trim(),
        role: document.getElementById('user-role')?.value,
        status: document.getElementById('user-status')?.value
      };

      if (!data.username) {
        Toast.show('Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p', 'error');
        return;
      }

      const isNew = !data.id;

      if (isNew && (!data.password || data.password.length < 6)) {
        Toast.show('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
        return;
      }

      Loading.show(isNew ? 'ƒêang th√™m...' : 'ƒêang l∆∞u...');

      API.call('saveUser', [this.state.sessionId, data, isNew])
        .then(result => {
          Loading.hide();
          if (result.success) {
            Toast.show(result.message || 'ƒê√£ l∆∞u', 'success');
            Modal.close('user-form');
            this.loadData();
          } else {
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    deleteUser(userId) {
      if (userId === this.state.user?.id) {
        Toast.show('Kh√¥ng th·ªÉ t·ª± x√≥a t√†i kho·∫£n', 'error');
        return;
      }

      const user = this.state.users.find(u => u.id === userId);
      if (!user) return;

      Modal.confirm('X√≥a ng∆∞·ªùi d√πng', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${user.displayName || user.username}"?`, () => {
        Loading.show('ƒêang x√≥a...');

        API.call('deleteUser', [this.state.sessionId, userId])
          .then(result => {
            Loading.hide();
            if (result.success) {
              Toast.show('ƒê√£ x√≥a', 'success');
              Modal.close('user-form');
              this.loadData();
            } else {
              Toast.show(result.error || 'L·ªói', 'error');
            }
          })
          .catch(error => {
            Loading.hide();
            Toast.show('L·ªói: ' + error.message, 'error');
          });
      }, true);
    },

    // Category CRUD
    openAddCategory() {
      this.ui.editingCat = null;
      Modal.showSheet('category-form', UI.renderCategoryForm());
    },

    openEditCategory(catId) {
      const cat = this.state.categories.find(c => c.id === catId);
      if (!cat) {
        Toast.show('Kh√¥ng t√¨m th·∫•y danh m·ª•c', 'error');
        return;
      }

      this.ui.editingCat = cat;
      Modal.showSheet('category-form', UI.renderCategoryForm(cat));
    },

    saveCategory() {
      const data = {
        id: this.ui.editingCat?.id || null,
        name: document.getElementById('cat-name')?.value?.trim(),
        icon: document.getElementById('cat-icon')?.value || 'fa-folder',
        description: document.getElementById('cat-desc')?.value?.trim(),
        sortOrder: parseInt(document.getElementById('cat-sort')?.value) || 0
      };

      if (!data.name) {
        Toast.show('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c', 'error');
        return;
      }

      const isNew = !data.id;
      Loading.show(isNew ? 'ƒêang th√™m...' : 'ƒêang l∆∞u...');

      API.call('saveCategory', [this.state.sessionId, data, isNew])
        .then(result => {
          Loading.hide();
          if (result.success) {
            Toast.show(result.message || 'ƒê√£ l∆∞u', 'success');
            Modal.close('category-form');
            this.loadData();
          } else {
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    deleteCategory(catId) {
      const cat = this.state.categories.find(c => c.id === catId);
      if (!cat) return;

      const appsInCat = this.state.apps.filter(a => a.category === cat.name).length;
      if (appsInCat > 0) {
        Toast.show(`C√≥ ${appsInCat} ·ª©ng d·ª•ng trong danh m·ª•c n√†y, kh√¥ng th·ªÉ x√≥a`, 'warning');
        return;
      }

      Modal.confirm('X√≥a danh m·ª•c', `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${cat.name}"?`, () => {
        Loading.show('ƒêang x√≥a...');

        API.call('deleteCategory', [this.state.sessionId, catId])
          .then(result => {
            Loading.hide();
            if (result.success) {
              Toast.show('ƒê√£ x√≥a', 'success');
              Modal.close('category-form');
              this.loadData();
            } else {
              Toast.show(result.error || 'L·ªói', 'error');
            }
          })
          .catch(error => {
            Loading.hide();
            Toast.show('L·ªói: ' + error.message, 'error');
          });
      }, true);
    },

    // Icon picker
    selectIcon(icon) {
      document.getElementById('cat-icon').value = icon;
      document.querySelectorAll('.icon-picker-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.icon === icon);
      });
    },

    // ===================================================================
    // 20. CHANGE PASSWORD
    // ===================================================================
    openChangePassword() {
      if (this.isGuest()) {
        Toast.show('Kh√°ch kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u', 'warning');
        return;
      }
      Modal.showSheet('change-password', UI.renderChangePassword());
    },

    changePassword() {
      const current = document.getElementById('cur-pwd')?.value;
      const newPwd = document.getElementById('new-pwd')?.value;
      const confirm = document.getElementById('confirm-pwd')?.value;

      if (!current) {
        Toast.show('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i', 'error');
        return;
      }

      if (!newPwd || newPwd.length < 6) {
        Toast.show('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±', 'error');
        return;
      }

      if (newPwd !== confirm) {
        Toast.show('X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp', 'error');
        return;
      }

      Loading.show('ƒêang ƒë·ªïi m·∫≠t kh·∫©u...');

      API.call('changePassword', [this.state.sessionId, current, newPwd])
        .then(result => {
          Loading.hide();
          if (result.success) {
            Toast.show('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng', 'success');
            Modal.close('change-password');
          } else {
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    },

    // ===================================================================
    // 21. CONTACT
    // ===================================================================
    openContact() {
      Modal.showSheet('contact', UI.renderContact());
    },

    submitContact() {
      const name = document.getElementById('contact-name')?.value?.trim();
      const email = document.getElementById('contact-email')?.value?.trim();
      const message = document.getElementById('contact-message')?.value?.trim();

      if (!name || !email || !message) {
        Toast.show('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
        return;
      }

      Loading.show('ƒêang g·ª≠i...');

      API.call('submitContact', [this.state.sessionId, { name, email, message }])
        .then(result => {
          Loading.hide();
          if (result.success) {
            Toast.show('ƒê√£ g·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng', 'success');
            Modal.close('contact');
          } else {
            Toast.show(result.error || 'L·ªói', 'error');
          }
        })
        .catch(error => {
          Loading.hide();
          Toast.show('L·ªói: ' + error.message, 'error');
        });
    }
  };

  // ===================================================================
  // API WRAPPER
  // ===================================================================
  const API = {
    call(functionName, args = []) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
        [functionName](...args);
      });
    }
  };

  // ===================================================================
  // TOAST NOTIFICATIONS
  // ===================================================================
  const Toast = {
    show(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const icons = {
        success: 'fa-check',
        error: 'fa-times',
        warning: 'fa-exclamation',
        info: 'fa-info'
      };

      const id = 'toast-' + Date.now();

      const html = `
      <div class="toast ${type}" id="${id}">
        <div class="toast-icon"><i class="fas ${icons[type] || icons.info}"></i></div>
        <span class="toast-message">${this.escape(message)}</span>
        <button class="toast-close" onclick="Toast.remove('${id}')"><i class="fas fa-times"></i></button>
      </div>
    `;

      container.insertAdjacentHTML('beforeend', html);

      setTimeout(() => this.remove(id), duration);
    },

    remove(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('removing');
        setTimeout(() => el.remove(), 200);
      }
    },

    escape(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  // ===================================================================
  // LOADING OVERLAY
  // ===================================================================
  const Loading = {
    show(text = 'ƒêang x·ª≠ l√Ω...') {
      const overlay = document.getElementById('loading-overlay');
      const textEl = document.getElementById('loading-text');
      if (textEl) textEl.textContent = text;
      if (overlay) overlay.classList.add('show');
    },

    hide() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.remove('show');
    }
  };

  // ===================================================================
  // MODAL MANAGER
  // ===================================================================
  const Modal = {
    stack: [],

    showOverlay(id, onClose) {
      let overlay = document.getElementById(id);
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = id;
        overlay.className = 'overlay';
        if (onClose) overlay.onclick = onClose;
        document.getElementById('modals-container').appendChild(overlay);
      }
      setTimeout(() => overlay.classList.add('show'), 10);
    },

    hideOverlay(id) {
      const overlay = document.getElementById(id);
      if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => overlay.remove(), 300);
      }
    },

    showSheet(name, content) {
      const container = document.getElementById('modals-container');

      // Create overlay
      const overlayId = `overlay-${name}`;
      this.showOverlay(overlayId, () => this.close(name));

      // Create sheet
      const sheet = document.createElement('div');
      sheet.id = `sheet-${name}`;
      sheet.className = 'sheet';
      sheet.innerHTML = content;

      container.appendChild(sheet);

      // Show with animation
      setTimeout(() => sheet.classList.add('show'), 10);

      this.stack.push(name);

      // ‚≠ê Push history (tr·ª´ app-detail v√¨ ƒë√£ push ·ªü openAppDetail)
      if (name !== 'app-detail' && !History.isNavigating) {
        History.push({ type: 'sheet', sheet: name });
      }
    },

    close(name) {
      const sheet = document.getElementById(`sheet-${name}`);
      const overlayId = `overlay-${name}`;

      if (sheet) {
        sheet.classList.remove('show');
        setTimeout(() => sheet.remove(), 300);
      }

      this.hideOverlay(overlayId);

      this.stack = this.stack.filter(n => n !== name);
    },

    closeAll() {
      [...this.stack].forEach(name => this.close(name));
      this.stack = [];
    },

    showActionSheet(actions) {
      const container = document.getElementById('modals-container');

      // Create overlay
      this.showOverlay('action-overlay', () => this.closeActionSheet());

      // Create action sheet
      const sheet = document.createElement('div');
      sheet.id = 'action-sheet';
      sheet.className = 'action-sheet';

      const actionsHtml = actions
        .filter(a => !a.disabled)
        .map((action, i) => `
        <div class="action-sheet-item ${action.destructive ? 'destructive' : ''}" 
             onclick="Modal.handleAction(${i})">
          ${Toast.escape(action.text)}
        </div>
      `).join('');

      sheet.innerHTML = `
      <div class="action-sheet-group">${actionsHtml}</div>
      <div class="action-sheet-group">
        <div class="action-sheet-item cancel" onclick="Modal.closeActionSheet()">H·ªßy</div>
      </div>
    `;

      // Store handlers
      this._actionHandlers = actions.filter(a => !a.disabled).map(a => a.handler);

      container.appendChild(sheet);
      setTimeout(() => sheet.classList.add('show'), 10);
    },

    handleAction(index) {
      const handler = this._actionHandlers?.[index];
      this.closeActionSheet();
      if (handler) setTimeout(handler, 100);
    },

    closeActionSheet() {
      const sheet = document.getElementById('action-sheet');
      if (sheet) {
        sheet.classList.remove('show');
        setTimeout(() => sheet.remove(), 300);
      }
      this.hideOverlay('action-overlay');
      this._actionHandlers = null;
    },

    confirm(title, message, onConfirm, destructive = false) {
      this.showActionSheet([
        { text: title, disabled: true },
        { text: message, disabled: true },
        { text: 'X√°c nh·∫≠n', destructive: destructive, handler: onConfirm },
      ]);
    }
  };

  // ===================================================================
  // HISTORY MANAGEMENT - Qu·∫£n l√Ω n√∫t Back tr√¨nh duy·ªát
  // ===================================================================
  const History = {
    // Stack l∆∞u tr·∫°ng th√°i
    stack: [],
    isNavigating: false,

    // Kh·ªüi t·∫°o
    init() {
      // ƒê·∫∑t state ban ƒë·∫ßu
      const initialState = { type: 'tab', tab: 'home', timestamp: Date.now() };
      window.history.replaceState(initialState, '', window.location.href);
      this.stack = [initialState];

      // L·∫Øng nghe s·ª± ki·ªán Back/Forward
      window.addEventListener('popstate', (e) => this.handlePopState(e));

      console.log('üìú History Management initialized');
    },

    // Th√™m state m·ªõi v√†o l·ªãch s·ª≠
    push(state) {
      if (this.isNavigating) return;

      state.timestamp = Date.now();
      this.stack.push(state);
      window.history.pushState(state, '', window.location.href);

      console.log('üìú History push:', state.type, state);
    },

    // X·ª≠ l√Ω khi user b·∫•m Back
    handlePopState(event) {
      this.isNavigating = true;

      const state = event.state;
      console.log('üìú History popstate:', state);

      if (!state) {
        // Kh√¥ng c√≥ state ‚Üí v·ªÅ home
        this.navigateTo({ type: 'tab', tab: 'home' });
        this.isNavigating = false;
        return;
      }

      // X·ª≠ l√Ω theo lo·∫°i state
      switch (state.type) {
        case 'tab':
          this.navigateToTab(state.tab);
          break;

        case 'sheet':
          // N·∫øu back t·ª´ sheet ‚Üí ƒë√≥ng sheet hi·ªán t·∫°i
          this.closeCurrentSheet();
          break;

        case 'app-detail':
          // N·∫øu back t·ª´ app detail ‚Üí ƒë√≥ng detail
          this.closeAppDetail();
          break;

        default:
          this.navigateToTab('home');
      }

      // C·∫≠p nh·∫≠t stack
      if (this.stack.length > 1) {
        this.stack.pop();
      }

      this.isNavigating = false;
    },

    // Navigate ƒë·∫øn tab (kh√¥ng push history)
    navigateToTab(tabName) {
      App.ui.currentTab = tabName;

      // Update tab bar
      document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabName);
      });

      // Update sidebar
      document.querySelectorAll('.sidebar-nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabName);
      });

      // Render page
      UI.renderPage(tabName);

      // Close mobile sidebar
      if (!App.ui.isDesktop) {
        App.closeSidebar();
      }
    },

    // ƒê√≥ng sheet hi·ªán t·∫°i
    closeCurrentSheet() {
      const sheets = Modal.stack;
      if (sheets.length > 0) {
        const lastSheet = sheets[sheets.length - 1];
        Modal.close(lastSheet);
      }
    },

    // ƒê√≥ng app detail
    closeAppDetail() {
      if (App.ui.isDesktop) {
        App.closePanel();
      } else {
        Modal.close('app-detail');
      }
    },

    // Navigate ƒë·∫øn state c·ª• th·ªÉ
    navigateTo(state) {
      switch (state.type) {
        case 'tab':
          this.navigateToTab(state.tab);
          break;
      }
    },

    // Thay th·∫ø state hi·ªán t·∫°i (kh√¥ng th√™m v√†o stack)
    replace(state) {
      state.timestamp = Date.now();
      window.history.replaceState(state, '', window.location.href);
      if (this.stack.length > 0) {
        this.stack[this.stack.length - 1] = state;
      }
    }
  };

  // ===================================================================
  // SCROLL BEHAVIOR - ·∫®n/hi·ªán Tab Bar khi cu·ªôn
  // ===================================================================
  const ScrollBehavior = {
    lastScrollTop: 0,
    ticking: false,
    tabBar: null,
    fab: null,
    threshold: 10, // Ng∆∞·ª°ng scroll t·ªëi thi·ªÉu ƒë·ªÉ k√≠ch ho·∫°t

    init() {
      this.tabBar = document.getElementById('tab-bar');
      this.fab = document.getElementById('fab-add');

      const pageContent = document.getElementById('page-content');
      if (pageContent) {
        pageContent.addEventListener('scroll', (e) => this.onScroll(e), { passive: true });
      }

      console.log('üìú ScrollBehavior initialized');
    },

    onScroll(e) {
      if (!App.settings.hideTabBarOnScroll) return;
      if (App.ui.isDesktop) return; // Ch·ªâ √°p d·ª•ng cho mobile

      const scrollTop = e.target.scrollTop;

      if (!this.ticking) {
        window.requestAnimationFrame(() => {
          this.handleScroll(scrollTop);
          this.ticking = false;
        });
        this.ticking = true;
      }
    },

    handleScroll(scrollTop) {
      const diff = scrollTop - this.lastScrollTop;

      // Cu·ªôn xu·ªëng ƒë·ªß ng∆∞·ª°ng ‚Üí ·∫©n
      if (diff > this.threshold && scrollTop > 100) {
        this.hide();
      }
      // Cu·ªôn l√™n ƒë·ªß ng∆∞·ª°ng ‚Üí hi·ªán
      else if (diff < -this.threshold) {
        this.show();
      }

      this.lastScrollTop = scrollTop;
    },

    hide() {
      if (this.tabBar) this.tabBar.classList.add('hidden');
      if (this.fab) this.fab.classList.add('expanded');
    },

    show() {
      if (this.tabBar) this.tabBar.classList.remove('hidden');
      if (this.fab) this.fab.classList.remove('expanded');
    },

    // Reset v·ªÅ tr·∫°ng th√°i hi·ªán
    reset() {
      this.lastScrollTop = 0;
      this.show();
    }
  };

  // ===================================================================
  // VIEW MODE - Toggle Grid/List
  // ===================================================================
  const ViewMode = {
    // Toggle gi·ªØa grid v√† list
    toggle() {
      App.settings.viewMode = App.settings.viewMode === 'grid' ? 'list' : 'grid';
      App.saveSettings();

      // Re-render trang hi·ªán t·∫°i
      UI.renderPage(App.ui.currentTab);

      Toast.show(`Ch·∫ø ƒë·ªô xem: ${App.settings.viewMode === 'grid' ? 'L∆∞·ªõi' : 'Danh s√°ch'}`, 'success');
    },

    // Set mode c·ª• th·ªÉ
    set(mode) {
      if (mode !== 'grid' && mode !== 'list') return;
      App.settings.viewMode = mode;
      App.saveSettings();
      UI.renderPage(App.ui.currentTab);
    },

    // L·∫•y mode hi·ªán t·∫°i
    get() {
      return App.settings.viewMode || 'grid';
    },

    // Ki·ªÉm tra c√≥ ph·∫£i grid kh√¥ng
    isGrid() {
      return this.get() === 'grid';
    }
  };

  // ===================================================================
  // PAGINATION - Ph√¢n trang
  // ===================================================================
  const Pagination = {
    // State
    state: {
      currentPage: 1,
      itemsPerPage: 20,
      totalItems: 0,
      totalPages: 0
    },

    // C√°c option s·ªë items/trang
    perPageOptions: [10, 20, 30, 50],

    // Kh·ªüi t·∫°o v·ªõi data
    init(totalItems) {
      this.state.totalItems = totalItems;
      this.state.itemsPerPage = App.settings.itemsPerPage || 20;
      this.state.currentPage = 1;
      this.calculateTotalPages();
    },

    // T√≠nh t·ªïng s·ªë trang
    calculateTotalPages() {
      this.state.totalPages = Math.ceil(this.state.totalItems / this.state.itemsPerPage);
      // ƒê·∫£m b·∫£o currentPage kh√¥ng v∆∞·ª£t qu√° totalPages
      if (this.state.currentPage > this.state.totalPages && this.state.totalPages > 0) {
        this.state.currentPage = this.state.totalPages;
      }
    },

    // L·∫•y items cho trang hi·ªán t·∫°i
    getPageItems(items) {
      const start = (this.state.currentPage - 1) * this.state.itemsPerPage;
      const end = start + this.state.itemsPerPage;
      return items.slice(start, end);
    },

    // Chuy·ªÉn ƒë·∫øn trang
    goToPage(page) {
      if (page < 1 || page > this.state.totalPages) return;
      this.state.currentPage = page;

      // Re-render
      UI.renderPage(App.ui.currentTab);

      // Scroll to top
      const pageContent = document.getElementById('page-content');
      if (pageContent) pageContent.scrollTop = 0;
    },

    // Trang tr∆∞·ªõc
    prevPage() {
      this.goToPage(this.state.currentPage - 1);
    },

    // Trang sau
    nextPage() {
      this.goToPage(this.state.currentPage + 1);
    },

    // Thay ƒë·ªïi s·ªë items/trang
    setItemsPerPage(count) {
      this.state.itemsPerPage = count;
      App.settings.itemsPerPage = count;
      App.saveSettings();

      // Reset v·ªÅ trang 1
      this.state.currentPage = 1;
      this.calculateTotalPages();

      // Re-render
      UI.renderPage(App.ui.currentTab);

      Toast.show(`Hi·ªÉn th·ªã ${count} ·ª©ng d·ª•ng/trang`, 'success');
    },

    // Ki·ªÉm tra c√≥ c·∫ßn pagination kh√¥ng
    needsPagination() {
      return this.state.totalItems > this.state.itemsPerPage;
    },

    // Render pagination UI
    render() {
      if (!this.needsPagination()) return '';

      const { currentPage, totalPages, itemsPerPage } = this.state;

      // T·∫°o array c√°c s·ªë trang ƒë·ªÉ hi·ªÉn th·ªã
      let pages = [];
      const maxVisible = 5;

      if (totalPages <= maxVisible) {
        pages = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        // Lu√¥n hi·ªán trang 1
        pages.push(1);

        // T√≠nh start v√† end
        let start = Math.max(2, currentPage - 1);
        let end = Math.min(totalPages - 1, currentPage + 1);

        // Th√™m ... n·∫øu c·∫ßn
        if (start > 2) pages.push('...');

        for (let i = start; i <= end; i++) {
          pages.push(i);
        }

        if (end < totalPages - 1) pages.push('...');

        // Lu√¥n hi·ªán trang cu·ªëi
        pages.push(totalPages);
      }

      return `
      <div class="pagination-wrapper">
        <div class="pagination">
          <button class="pagination-btn" onclick="Pagination.prevPage()" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
          </button>
          
          <div class="pagination-pages">
            ${pages.map(p => {
        if (p === '...') {
          return '<span class="pagination-ellipsis">...</span>';
        }
        return `
                <button class="pagination-page ${p === currentPage ? 'active' : ''}" 
                        onclick="Pagination.goToPage(${p})">
                  ${p}
                </button>
              `;
      }).join('')}
          </div>
          
          <button class="pagination-btn" onclick="Pagination.nextPage()" ${currentPage === totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        
        <div class="pagination-info">
          <span class="text-secondary text-sm">Hi·ªÉn th·ªã</span>
          <select class="pagination-select" onchange="Pagination.setItemsPerPage(Number(this.value))">
            ${this.perPageOptions.map(opt => `
              <option value="${opt}" ${opt === itemsPerPage ? 'selected' : ''}>${opt}</option>
            `).join('')}
          </select>
          <span class="text-secondary text-sm">/ trang</span>
        </div>
      </div>
    `;
    }
  };


</script>